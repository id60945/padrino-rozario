# Реализация подстановки имени клиента через json_order

## Описание

Реализована подстановка реального имени клиента в микроразметку schema.org на страницах смайлов **без изменения структуры базы данных**.

### Логика работы:

1. Парсим `json_order` из таблицы `smiles`
2. Берем первый элемент (`"0"`) с `id` - **это ID заказа**
3. Ищем заказ в таблице `orders` по **точному ID**:
   - `Order.find_by_id(order_id)` или
   - `Order.find_by_eight_digit_id(order_id)`
4. Проверяем `order.useraccount_id > 0`
5. Получаем `user_account.surname` из `user_accounts`
6. Возвращаем surname или "Покупатель"

### Пример json_order:

```json
{
  "0": {
    "id": "3027",      // <- это ID заказа в таблице orders
    "complect": "standard"
  }
}
```

⚠ **Важно**: Поле "id" в json_order означает ID заказа, а не ID товара!

## Изменения

### Модифицированные файлы:

1. **app/models/smile.rb**
   - Добавлен метод `customer_name`
   - Логика поиска заказа по json_order

2. **app/views/smiles/show.erb**
   - Обновлена микроразметка:
     - `"name": "<%=@post.customer_name%>"` - реальное имя клиента
     - `"datePublished": "<%=@post.created_at.strftime('%Y-%m-%d')%>"` - реальная дата создания
     - `"ratingValue": "<%=@post.rating%>"` - реальный рейтинг из БД

### Новые файлы:

1. **test_customer_name_json.rb** - тесты функциональности customer_name
2. **test_micromarkup_data.rb** - тесты подстановки даты и рейтинга

## Преимущества решения

✅ **Никаких изменений в БД** - используем существующие поля  
✅ **Никаких миграций** - можно сразу разворачивать  
✅ **Обратная совместимость** - все существующие smiles работают  
✅ **Отказоустойчивость** - при ошибках возвращает "Покупатель"  

## Развертывание

Просто обновить файлы - никаких дополнительных действий не нужно!

### Проверка

1. Открыть любую страницу smile
2. Проверить в исходном коде микроразметку
3. Поле `"name"` в `"author"` должно содержать реальную фамилию или "Покупатель"

### Тестирование

```bash
# Тест имени клиента
ruby test_customer_name_json.rb

# Тест даты и рейтинга
ruby test_micromarkup_data.rb
```

Ожидаемый вывод:
```
✓ Тест 1 прошел: Петров
✓ Тест 2 прошел: Покупатель
✓ Тест 3 прошел: Покупатель
✓ Тест 4 прошел: Покупатель
...
✓ Тест 1 (дата) прошел: 2023-12-25
✓ Тест 2 (рейтинг=5) прошел: 5
```

## Ограничения и особенности

1. **Точный поиск по ID**: Очень быстро и надежно
2. **Только первый заказ**: Используется элемент "0" из json_order
3. **Поддержка двух типов ID**: Обычный `id` и `eight_digit_id`
4. **Обработка ошибок**: Любые ошибки возвращают "Покупатель"

## Откат изменений

Просто вернуть `"name": "Имя клиента"` в `app/views/smiles/show.erb`.
